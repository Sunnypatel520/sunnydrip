<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheDRIP - Local Storage CRM</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; /* gray-800 */ }
        ::-webkit-scrollbar-thumb { background: #4b5563; /* gray-600 */ border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; /* gray-500 */ }

        /* Ensure the body and main content fill the viewport */
        html, body, #app { height: 100%; margin: 0; }
        .router-view { display: none; }
        .router-view.active { display: block; }

        /* Specific style for the slide-out history panel */
        .slide-panel {
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
        }
        .slide-panel.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-900 font-sans">
    <div id="app" class="flex h-screen w-full">
        <!-- Application will be rendered here -->
    </div>

    <script>
        // --- CORE APPLICATION LOGIC (Vanilla JavaScript) ---

        // Shared Tailwind Classes for consistency
        const baseClasses = {
            primaryBg: "bg-gray-900",
            secondaryBg: "bg-gray-800",
            cardBg: "bg-gray-800/70",
            primaryText: "text-gray-100",
            secondaryText: "text-gray-400",
            accent: "bg-purple-600 hover:bg-purple-700 text-white",
            accentOutline: "border border-purple-600 text-purple-400 hover:bg-purple-900",
            // FIX: Added text-white to ensure visibility in dark mode input fields
            input: "w-full p-2.5 rounded-lg border border-gray-700 bg-gray-900 focus:ring-purple-500 focus:border-purple-500 text-white",
        };
        
        const LOCAL_STORAGE_KEY_CLIENTS = 'drip_crm_clients';
        const LOCAL_STORAGE_KEY_DRIPS = 'drip_crm_drips';
        const TOTAL_MESSAGES = 12;

        // --- Data Initialization and Local Storage Functions ---

        const placeholderMessages = (dripName) => {
            const isRE = dripName.includes('Real Estate');
            const isNoDrip = dripName.includes('No Drip');
            
            const messages = {};
            for (let i = 1; i <= 12; i++) {
                if (isNoDrip) {
                     messages[i] = `[PLACEHOLDER - NO MESSAGE SET]`;
                } else {
                    messages[i] = isRE 
                        ? `RE Message ${i}: Hi {{firstName}}, just touching base about real estate.`
                        : `SaaS Message ${i}: Checking in on your trial, {{firstName}}.`;
                }
            }
            return messages;
        };

        const initialDripsData = [
            { id: 'real_estate_outreach', name: 'Real Estate Outreach', messages: placeholderMessages('Real Estate Outreach') },
            { id: 'saas_trial_followup', name: 'SaaS Trial Follow-up', messages: placeholderMessages('SaaS Trial Follow-up') },
            { id: 'no_drip', name: 'No Drip - Parking Lot', messages: placeholderMessages('No Drip') }, // NEW No Drip Option
        ];

        const getInitialTestClients = (drips) => {
            const now = new Date();
            const oneDay = 24 * 60 * 60 * 1000;

            return [
                {
                    id: 'client_001', firstName: 'Sarah', lastName: 'Connor', phone: '+15551234567', url: 'https://linkedin.com/in/sarahconnor',
                    dripCampaignId: drips[0].id, currentMessageIndex: 1, lastSentDate: null, nextDueDate: now.toISOString(),
                    customMessages: {}, notes: [{ type: 'System', content: 'Client auto-added for testing.', timestamp: now.toISOString() }],
                },
                {
                    id: 'client_002', firstName: 'John', lastName: 'Smith', phone: '+15557654321', url: 'https://linkedin.com/in/johnsmith',
                    dripCampaignId: drips[1].id, currentMessageIndex: 3, lastSentDate: new Date(now.getTime() - (8 * oneDay)).toISOString(),
                    nextDueDate: new Date(now.getTime() - (1 * oneDay)).toISOString(),
                    customMessages: {}, notes: [{ type: 'System', content: 'Client auto-added for testing.', timestamp: now.toISOString() }],
                },
                {
                    id: 'client_003', firstName: 'Maria', lastName: 'Garcia', phone: '+15559876543', url: 'https://linkedin.com/in/mariagarcia',
                    dripCampaignId: drips[0].id, currentMessageIndex: 2, lastSentDate: new Date(now.getTime() - (10 * oneDay)).toISOString(),
                    nextDueDate: new Date(now.getTime() - (3 * oneDay)).toISOString(),
                    customMessages: {}, notes: [{ type: 'System', content: 'Client auto-added for testing.', timestamp: now.toISOString() }],
                },
            ];
        };

        const loadData = () => {
            const storedClients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_CLIENTS));
            const storedDrips = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_DRIPS));

            // Setup Drips
            let drips = storedDrips || initialDripsData;
            // Ensure No Drip exists if loading old data without it
            if (!drips.find(d => d.id === 'no_drip')) {
                drips.push({ id: 'no_drip', name: 'No Drip - Parking Lot', messages: placeholderMessages('No Drip') });
            }
            if (!storedDrips) {
                localStorage.setItem(LOCAL_STORAGE_KEY_DRIPS, JSON.stringify(drips));
            }

            // Setup Clients
            let clients = storedClients;
            if (!clients || clients.length === 0) {
                clients = getInitialTestClients(drips);
                localStorage.setItem(LOCAL_STORAGE_KEY_CLIENTS, JSON.stringify(clients));
            }

            return { clients, drips };
        };
        
        const saveData = (clients, drips) => {
            localStorage.setItem(LOCAL_STORAGE_KEY_CLIENTS, JSON.stringify(clients));
            localStorage.setItem(LOCAL_STORAGE_KEY_DRIPS, JSON.stringify(drips));
        };
        
        // --- System Health Check (New Function) ---
        const getStorageHealth = () => {
            let totalBytes = 0;
            // Calculate size of stored data
            Object.keys(localStorage).forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    // Estimate size using string length (1 character = 2 bytes in JavaScript UTF-16)
                    totalBytes += value.length * 2; 
                }
            });
            
            const totalKB = (totalBytes / 1024).toFixed(2);
            // Storage limit is usually 5MB (5120 KB)
            const limitMB = 5; 
            const totalClients = data.clients.length;

            let healthStatus = 'Optimal';
            let healthColor = 'text-green-400';
            
            if (totalKB > (limitMB * 0.5 * 1024)) { // Warning if over 50% of the 5MB limit (~2560 KB)
                healthStatus = 'Monitor (High Usage)';
                healthColor = 'text-yellow-400';
            }
            if (totalKB > (limitMB * 0.8 * 1024)) { // Critical if over 80%
                healthStatus = 'CRITICAL (Data at Risk)';
                healthColor = 'text-red-400';
            }

            return { totalKB, totalClients, healthStatus, healthColor };
        };


        // Global data store
        let data = loadData();
        let currentView = 'Dashboard';
        let selectedClient = null;
        let dashboardViewType = 'card'; // Default to card view
        let dashboardFilter = 'all'; // New state for stat card filtering
        let isNotesPanelOpen = false; // NEW state for the profile notes panel

        // --- Core Logic ---

        const getClientStatus = (client) => {
            const isFinished = client.currentMessageIndex > TOTAL_MESSAGES;
            // Check if client has a nextDueDate and if it's past
            const isOverdue = client.nextDueDate && new Date(client.nextDueDate).getTime() <= new Date().getTime();
            
            if (isFinished) return 'complete';
            if (isOverdue) return 'overdue';
            return 'active';
        };

        const calculateNextDueDate = () => {
            const now = new Date();
            const oneWeekInMilliseconds = 7 * 24 * 60 * 60 * 1000;
            return new Date(now.getTime() + oneWeekInMilliseconds).toISOString();
        };

        const getDripContent = (dripId, messageIndex, client) => {
            const drip = data.drips.find(d => d.id === dripId);
            
            const customContent = client.customMessages ? client.customMessages[String(messageIndex)] : null;
            
            if (drip && drip.messages) {
                let content = customContent || drip.messages[String(messageIndex)] || `[ERROR: Message ${messageIndex} not found]`;
                // ENHANCEMENT: Implement all personalization placeholders
                content = content.replace(/\{\{firstName\}\}/g, client.firstName || 'Client');
                content = content.replace(/\{\{lastName\}\}/g, client.lastName || 'Client');
                content = content.replace(/\{\{URL\}\}/g, client.url || '[No URL]');
                return content;
            }
            return "Loading content...";
        };

        // --- Router and View Renderer ---

        const navigateTo = (view, client = null) => {
            currentView = view;
            selectedClient = client;
            
            // Reset filter when navigating away from Dashboard
            if (view !== 'Dashboard') {
                dashboardFilter = 'all';
            }

            // Re-load data before navigation to ensure fresh state after local storage operations
            data = loadData(); 

            const views = ['Dashboard', 'Clients', 'Drips', 'Profile', 'AddClient', 'AddDrip', 'BulkAddClient']; // Added BulkAddClient
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) {
                    el.classList.remove('active');
                    el.classList.add('hidden');
                }
            });

            const activeView = client ? 'Profile' : view;
            
            const el = document.getElementById(activeView);
            if (el) {
                el.classList.add('active');
                el.classList.remove('hidden');
            }
            
            // Render the current view content
            if (activeView === 'Dashboard') renderDashboard();
            if (activeView === 'Clients') renderClientsList();
            if (activeView === 'Drips') renderDripCampaigns();
            if (activeView === 'Profile') renderClientProfile(client);
            if (activeView === 'AddClient') renderAddClientForm();
            if (activeView === 'AddDrip') renderAddDripForm();
            if (activeView === 'BulkAddClient') renderBulkAddClientForm(); // Render new form
            
            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white', 'font-semibold', 'shadow-lg');
                const targetView = btn.dataset.view;
                if (targetView === activeView || 
                    (targetView === 'Clients' && (activeView === 'Profile' || activeView === 'AddClient' || activeView === 'BulkAddClient')) || // Update Clients nav item to include new views
                    (targetView === 'Drips' && activeView === 'AddDrip')) {
                    btn.classList.add('bg-purple-600', 'text-white', 'font-semibold', 'shadow-lg');
                }
            });
        };
        
        // --- Dashboard Actions (Rewritten to use localStorage) ---
        const handleSendAction = (clientId) => {
            const clientIndex = data.clients.findIndex(c => c.id === clientId);
            if (clientIndex === -1 || data.clients[clientIndex].currentMessageIndex > TOTAL_MESSAGES) return;

            const client = data.clients[clientIndex];
            const now = new Date();
            const nextIndex = client.currentMessageIndex + 1;
            const newDueDate = calculateNextDueDate(); 
            
            // 1. Log History
            const messageContent = getDripContent(client.dripCampaignId, client.currentMessageIndex, client);
            const sendNote = { type: 'Sent Message', content: `Sent Message ${client.currentMessageIndex} of ${TOTAL_MESSAGES}: "${messageContent}"`, timestamp: now.toISOString() };
            const updatedNotes = [...(client.notes || []), sendNote];

            // 2. Update Client Data (Floating Schedule)
            data.clients[clientIndex] = {
                ...client,
                currentMessageIndex: nextIndex,
                lastSentDate: now.toISOString(),
                nextDueDate: nextIndex <= TOTAL_MESSAGES ? newDueDate : null,
                customMessages: { ...client.customMessages, [client.currentMessageIndex]: null }, // Clear custom message for the message just sent
                notes: updatedNotes,
            };

            saveData(data.clients, data.drips);
            renderDashboard();
        };

        // --- Client Delete Action (New Feature) ---
        const handleDeleteClient = (clientId) => {
            // Using window.confirm for simplicity, since alert/confirm are allowed in this canvas environment
            const client = data.clients.find(c => c.id === clientId);
            if (!client) return;

            const confirmation = confirm(`Are you sure you want to permanently delete client: ${client.firstName} ${client.lastName}? This action cannot be undone.`);
            
            if (confirmation) {
                // Filter the clients array to remove the client by ID
                data.clients = data.clients.filter(c => c.id !== clientId);
                saveData(data.clients, data.drips);
                console.log(`Client ${clientId} deleted.`);
                
                // Navigate back to the Clients List after deletion
                navigateTo('Clients');
            }
        };


        // --- Drip Campaigns View Renderer ---
        
        const renderDripCampaigns = () => {
            const container = document.getElementById('Drips');
            if (!container) return;
            
            // Create the main HTML structure for the Drips View
            container.innerHTML = `
                <div class="p-8">
                    <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-white">Drip Campaigns</h1>
                        <button id="add-drip-btn" class="px-4 py-2 rounded-xl flex items-center gap-2 font-semibold ${baseClasses.accent}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Create Drip
                        </button>
                    </header>
                    
                    <section id="drips-list">
                        <h2 class="text-xl font-semibold mb-4 text-white">Premade Drips</h2>
                        <!-- Drip content will be injected here -->
                    </section>
                </div>
            `;
            
            // FIX: Attach event listener to the Create Drip button
            document.getElementById('add-drip-btn').onclick = () => navigateTo('AddDrip');
            
            const listContainer = document.getElementById('drips-list');

            data.drips.forEach(drip => {
                const dripEl = document.createElement('div');
                dripEl.className = `${baseClasses.secondaryBg} rounded-xl p-6 mb-6 shadow-2xl`;
                
                dripEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-purple-400">${drip.name}</h3>
                        <button data-drip-id="${drip.id}" class="toggle-edit-drip text-sm py-1 px-3 rounded-full ${baseClasses.accentOutline}">
                            Edit Template
                        </button>
                    </div>
                    <div id="edit-area-${drip.id}" class="mt-4 hidden space-y-3">
                        <!-- Message editor components will go here -->
                        <button data-drip-id="${drip.id}" class="save-drip-btn mt-4 w-full py-3 rounded-xl font-bold ${baseClasses.accent}">
                            Save Campaign Changes
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(dripEl);

                // Add event listeners for editing and saving
                dripEl.querySelector('.toggle-edit-drip').addEventListener('click', (e) => {
                    const id = e.target.dataset.dripId;
                    const editArea = document.getElementById(`edit-area-${id}`);
                    const button = e.target;
                    
                    if (editArea.classList.contains('hidden')) {
                        // Expand and render messages
                        editArea.classList.remove('hidden');
                        button.textContent = 'Collapse';
                        renderDripMessages(id, editArea);
                    } else {
                        // Collapse
                        editArea.classList.add('hidden');
                        button.textContent = 'Edit Template';
                        editArea.innerHTML = ''; // Clear content on collapse
                    }
                });
                
                dripEl.querySelector('.save-drip-btn').addEventListener('click', (e) => {
                    const id = e.target.dataset.dripId;
                    const dripIndex = data.drips.findIndex(d => d.id === id);
                    if (dripIndex === -1) return;

                    const editArea = document.getElementById(`edit-area-${id}`);
                    editArea.querySelectorAll('textarea').forEach(textarea => {
                        const messageIndex = textarea.dataset.index;
                        data.drips[dripIndex].messages[messageIndex] = textarea.value;
                    });
                    
                    saveData(data.clients, data.drips);
                    console.log(`Drip '${data.drips[dripIndex].name}' saved to localStorage.`);
                    
                    // Re-render to update the closed state/logic
                    navigateTo('Drips');
                });
            });
        };
        
        // Renders the message textareas for a single drip
        const renderDripMessages = (dripId, container) => {
            const drip = data.drips.find(d => d.id === dripId);
            if (!drip) return;
            
            let html = '';
            for (let i = 1; i <= TOTAL_MESSAGES; i++) {
                const content = drip.messages[String(i)] || '';
                html += `
                    <div class="${baseClasses.cardBg} p-4 rounded-xl shadow-lg">
                        <h4 class="text-lg font-semibold text-white">Message ${i}</h4>
                        <div class="mt-3">
                            <textarea
                                data-index="${i}"
                                class="${baseClasses.input} h-24"
                            >${content}</textarea>
                            <p class="${baseClasses.secondaryText} text-xs mt-1">
                                Use **\`{{firstName}}\`**, **\`{{lastName}}\`**, and **\`{{URL}}\`** for personalization.
                            </p>
                        </div>
                    </div>
                `;
            }
            // Re-inject the save button
            html += `<button data-drip-id="${drip.id}" class="save-drip-btn mt-4 w-full py-3 rounded-xl font-bold ${baseClasses.accent}">
                        Save Campaign Changes
                    </button>`;
            
            container.innerHTML = html;

            // Re-attach save button event listener
            container.querySelector('.save-drip-btn').addEventListener('click', (e) => {
                // Delegation handles the save logic already defined above
                const id = e.target.dataset.dripId;
                const dripIndex = data.drips.findIndex(d => d.id === id);
                if (dripIndex === -1) return;

                const editArea = document.getElementById(`edit-area-${id}`);
                editArea.querySelectorAll('textarea').forEach(textarea => {
                    const messageIndex = textarea.dataset.index;
                    data.drips[dripIndex].messages[messageIndex] = textarea.value;
                });
                
                saveData(data.clients, data.drips);
                console.log(`Drip '${data.drips[dripIndex].name}' saved to localStorage.`);
                
                navigateTo('Drips');
            });
        };
        
        // --- Add Drip Form Renderer (New Feature) ---
        const renderAddDripForm = () => {
             const container = document.getElementById('AddDrip');
             if (!container) return;

             container.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
                    <form id="new-drip-form" class="bg-gray-900 p-8 rounded-xl w-full max-w-2xl border border-purple-600 shadow-3xl max-h-screen overflow-y-auto">
                        <h2 class="text-2xl font-bold text-white mb-6">Create New Drip Campaign</h2>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Campaign Name (e.g., Cold Lead Nurture)</label>
                            <input type="text" name="name" placeholder="Enter Drip Campaign Name" required class="${baseClasses.input}" />
                            <p class="text-xs ${baseClasses.secondaryText} mt-1">This name appears in the client list.</p>
                        </div>

                        <h3 class="text-xl font-bold text-white mb-4 border-t border-gray-700 pt-4">Messages (${TOTAL_MESSAGES} Week Sequence)</h3>
                        <div id="new-drip-messages" class="space-y-4">
                            ${Array.from({ length: TOTAL_MESSAGES }, (_, i) => i + 1).map(index => `
                                <div class="${baseClasses.secondaryBg} p-4 rounded-xl">
                                    <label class="block text-lg font-semibold text-white">Message ${index}</label>
                                    <textarea name="message_${index}" placeholder="Enter message content for week ${index}" required class="${baseClasses.input} h-24 mt-2"></textarea>
                                    <p class="${baseClasses.secondaryText} text-xs mt-1">
                                        Use **\`{{firstName}}\`**, **\`{{lastName}}\`**, and **\`{{URL}}\`** for personalization.
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-end space-x-4 mt-8">
                            <button type="button" id="cancel-add-drip" class="py-2 px-4 rounded-lg ${baseClasses.accentOutline} hover:bg-gray-700/50">
                                Cancel
                            </button>
                            <button type="submit" class="py-2 px-4 rounded-lg font-bold ${baseClasses.accent}">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                Save New Drip
                            </button>
                        </div>
                    </form>
                </div>
             `;

             document.getElementById('cancel-add-drip').onclick = () => navigateTo('Drips');
             
             document.getElementById('new-drip-form').onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const name = formData.get('name').trim();

                if (!name) return;

                const messages = {};
                for (let i = 1; i <= TOTAL_MESSAGES; i++) {
                    messages[String(i)] = formData.get(`message_${i}`).trim();
                }

                const newDrip = {
                    id: 'drip_' + Date.now() + Math.random().toString(16).slice(2),
                    name: name,
                    messages: messages,
                };
                
                data.drips.push(newDrip);
                saveData(data.clients, data.drips);
                console.log(`New Drip Campaign created: ${name}`);
                navigateTo('Drips');
             };
        };


        // --- Client List Renderer ---

        const renderClientsList = () => {
            const container = document.getElementById('Clients');
            if (!container) return;

            let html = `
                <div class="p-8">
                    <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-white">Clients</h1>
                        <div class="flex space-x-4">
                            <button id="add-client-btn" class="px-4 py-2 rounded-xl flex items-center gap-2 font-semibold ${baseClasses.accent}">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                Add Client
                            </button>
                            <button id="bulk-add-client-btn" class="px-4 py-2 rounded-xl flex items-center gap-2 font-semibold ${baseClasses.accentOutline}">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Bulk Import
                            </button>
                        </div>
                    </header>
                    
                    <!-- Filters/Sort (Simplified for local version) -->
                    <div class="${baseClasses.secondaryBg} p-4 rounded-xl mb-6 shadow-inner">
                        <div class="flex flex-wrap items-center gap-4">
                            <input type="text" id="client-search" placeholder="Search clients by Name or Phone..." class="${baseClasses.input} w-full md:w-auto flex-grow text-white" />
                            <label class="${baseClasses.secondaryText}">Sort By:</label>
                            <select id="client-sort" class="${baseClasses.input} w-auto min-w-[150px]">
                                <option value="name">Name (A-Z)</option>
                                <option value="progress">Message Progress</option>
                            </select>
                        </div>
                    </div>

                    <div class="${baseClasses.secondaryBg} rounded-xl shadow-2xl overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Next Message</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Drip</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="divide-y divide-gray-700">
                                <!-- Rows injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            
            document.getElementById('add-client-btn').onclick = () => navigateTo('AddClient');
            document.getElementById('bulk-add-client-btn').onclick = () => navigateTo('BulkAddClient'); // Navigate to bulk add form
            
            const renderTableRows = (clients) => {
                const tbody = document.getElementById('clients-table-body');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                if (clients.length === 0) {
                     tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-500 italic">No clients found matching criteria.</td></tr>`;
                     return;
                }

                clients.forEach(client => {
                    const dripName = data.drips.find(d => d.id === client.dripCampaignId)?.name || 'N/A';
                    const status = getClientStatus(client);
                    const isOverdue = status === 'overdue';
                    const isFinished = status === 'complete';
                    const messageContent = getDripContent(client.dripCampaignId, client.currentMessageIndex, client);


                    const row = document.createElement('tr');
                    row.className = `${baseClasses.secondaryBg} border-b border-gray-700 hover:bg-gray-700 transition duration-150 cursor-pointer`;
                    // Note: Row click remains to navigate to profile
                    row.onclick = () => navigateTo('Profile', client); 
                    
                    // Button group HTML
                    const actionsHtml = isFinished ? `
                        <div class="flex justify-end space-x-2">
                             <span class="text-xs text-green-400 italic">Drip Completed</span>
                        </div>
                    ` : `
                        <div class="flex justify-end space-x-2" onclick="event.stopPropagation();">
                             <button title="Call Client" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="window.open('tel:${client.phone.replace(/[^0-9]/g, '')}', '_blank');"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.717 21 3 14.283 3 6V5z" /></svg></button>
                             <button title="WhatsApp Client" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="window.open('https://wa.me/${client.phone.replace(/[^0-9]/g, '')}', '_blank');">WA</button>
                             <button title="Copy Message" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigator.clipboard.writeText('${messageContent.replace(/'/g, "\\'")}')"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v1m-4 0v-1m4 1h-4m-4 0h-4m-4 0h-4m4 0v-1m4 1v-1m-4 1v-1" /></svg></button>
                             <button title="Edit Message / View Profile" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigateTo('Profile', data.clients.find(c => c.id === '${client.id}'));"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                             ${isOverdue ? `
                                 <button title="Mark as Sent & Schedule Next" class="p-2 rounded-lg ${baseClasses.accent} text-sm font-bold send-btn" data-client-id="${client.id}">
                                     <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                 </button>
                             ` : `
                                 <button title="Active (Wait)" class="p-2 rounded-lg bg-gray-600 text-gray-400 cursor-not-allowed">
                                     <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                 </button>
                             `}
                        </div>
                    `;


                    row.innerHTML = `
                        <td class="p-4 font-semibold text-white">${client.firstName} ${client.lastName}</td>
                        <td class="p-4">
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${isOverdue ? 'bg-red-800 text-red-100' : (isFinished ? 'bg-gray-600 text-gray-300' : 'bg-green-700 text-green-100')}">
                                ${isFinished ? 'Finished' : (isOverdue ? 'Overdue' : 'Active')}
                            </span>
                        </td>
                        <td class="p-4 text-gray-300">Message ${client.currentMessageIndex}</td>
                        <td class="p-4 text-purple-400">${dripName}</td>
                        <td class="p-4 text-right">${actionsHtml}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Re-attach send action listeners (for the Clients list only)
                tbody.querySelectorAll('.send-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Prevent the row navigation event from firing
                        e.stopPropagation(); 
                        handleSendAction(btn.dataset.clientId);
                    });
                });

            };

            const applyFiltersAndSort = () => {
                let clients = [...data.clients];
                const searchTerm = document.getElementById('client-search').value.toLowerCase();
                const sortOption = document.getElementById('client-sort').value;

                // Filtering
                clients = clients.filter(client => {
                    const fullName = `${client.firstName} ${client.lastName}`.toLowerCase();
                    return fullName.includes(searchTerm) || client.phone.includes(searchTerm);
                });

                // Sorting
                clients.sort((a, b) => {
                    if (sortOption === 'name') {
                        return (a.lastName || '').localeCompare(b.lastName || '');
                    }
                    if (sortOption === 'progress') {
                        return a.currentMessageIndex - b.currentMessageIndex;
                    }
                    return 0;
                });
                renderTableRows(clients);
            };

            document.getElementById('client-search').oninput = applyFiltersAndSort;
            document.getElementById('client-sort').onchange = applyFiltersAndSort;

            applyFiltersAndSort();
        };

        // --- Client Add Form Renderer ---
        
        const renderAddClientForm = () => {
             const container = document.getElementById('AddClient');
             if (!container) return;
             
             container.innerHTML = `
                 <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
                     <form id="new-client-form" class="bg-gray-900 p-8 rounded-xl w-full max-w-lg border border-purple-600 shadow-3xl">
                         <h2 class="text-2xl font-bold text-white mb-6">Add New Client (Single)</h2>
                         
                         <div class="grid grid-cols-2 gap-4 mb-4">
                             <input type="text" name="firstName" placeholder="First Name" required class="${baseClasses.input}" />
                             <input type="text" name="lastName" placeholder="Last Name" required class="${baseClasses.input}" />
                         </div>
                         
                         <div class="grid grid-cols-2 gap-4 mb-6">
                             <input type="tel" name="phone" placeholder="Phone Number (e.g., +15550101)" required class="${baseClasses.input}" />
                             <input type="url" name="url" placeholder="LinkedIn URL" class="${baseClasses.input}" />
                         </div>
                         
                         <div class="mb-8">
                             <label class="block text-sm font-medium text-gray-400 mb-2">Select Drip Campaign</label>
                             <select name="dripCampaignId" required class="${baseClasses.input}">
                                 ${data.drips.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                             </select>
                         </div>
        
                         <div class="flex justify-end space-x-4">
                             <button type="button" id="cancel-add-client" class="py-2 px-4 rounded-lg ${baseClasses.accentOutline} hover:bg-gray-700/50">
                                 Cancel
                             </button>
                             <button type="submit" class="py-2 px-4 rounded-lg font-bold ${baseClasses.accent}">
                                 <svg class="w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                 Add Client
                             </button>
                         </div>
                     </form>
                 </div>
             `;
             
             document.getElementById('cancel-add-client').onclick = () => navigateTo('Clients');
             
             document.getElementById('new-client-form').onsubmit = (e) => {
                 e.preventDefault();
                 const formData = new FormData(e.target);
                 const now = new Date();
                 
                 const newClient = {
                     id: 'client_' + Date.now() + Math.random().toString(16).slice(2),
                     firstName: formData.get('firstName'),
                     lastName: formData.get('lastName'),
                     phone: formData.get('phone'),
                     url: formData.get('url'),
                     dripCampaignId: formData.get('dripCampaignId'),
                     currentMessageIndex: 1,
                     lastSentDate: null,
                     nextDueDate: now.toISOString(),
                     customMessages: {},
                     notes: [{ 
                        type: 'System', 
                        content: `Client added and enrolled in ${data.drips.find(d => d.id === formData.get('dripCampaignId'))?.name || 'Drip'}.`, 
                        timestamp: now.toISOString() 
                    }],
                 };
                 
                 data.clients.push(newClient);
                 saveData(data.clients, data.drips);
                 console.log("Client added and Drip started!");
                 navigateTo('Clients');
             };
        };

        // --- BULK ADD CLIENTS RENDERER (New Implementation) ---

        const parsePastedData = (rawText, dripCampaignId) => {
            const lines = rawText.trim().split('\n').filter(line => line.trim() !== '');
            const newClients = [];
            let importCount = 0;
            let skippedCount = 0;
            const now = new Date();
            
            // Determine separator: check if tabs or commas are used (default to comma)
            const separator = rawText.includes('\t') ? '\t' : ',';
            
            lines.forEach((line, index) => {
                // Split the line by the determined separator
                const parts = line.split(separator).map(p => p.trim());
                
                // Assuming Name is column 1, Phone is column 2, URL is column 3
                // We are flexible on column order since the user might paste anything.
                
                let namePart = parts[0] || '';
                let phonePart = parts[1] || '';
                let urlPart = parts[2] || '';
                
                // Basic cleanup and validation
                if (!phonePart && parts.length > 1) {
                    // Try to guess phone if columns were swapped (simple check for starting with + or being mostly digits)
                    if (parts[1].match(/^\+?\d.*$/)) {
                        phonePart = parts[1];
                    }
                }
                
                // FINAL VALIDATION: Phone is mandatory
                if (!phonePart.match(/^\+?\d{7,}$/)) { 
                    console.warn(`Skipping row ${index + 1}: Phone number is missing or invalid.`);
                    skippedCount++;
                    return; 
                }

                let firstName = '';
                let lastName = '';
                
                // Parse Name: Split by space. 
                const nameParts = namePart.split(/\s+/).filter(p => p.length > 0);
                if (nameParts.length === 1) {
                    firstName = nameParts[0];
                } else if (nameParts.length >= 2) {
                    firstName = nameParts[0];
                    lastName = nameParts.slice(1).join(' '); // Everything else is last name
                } else {
                    firstName = 'Client'; // Fallback name
                }

                const newClient = {
                    id: 'client_' + Date.now() + Math.random().toString(16).slice(2),
                    firstName: firstName,
                    lastName: lastName,
                    phone: phonePart,
                    url: urlPart,
                    dripCampaignId: dripCampaignId,
                    currentMessageIndex: 1,
                    lastSentDate: null,
                    nextDueDate: now.toISOString(),
                    customMessages: {},
                    notes: [{ 
                        type: 'System', 
                        content: `Client added via Bulk Import and enrolled in selected Drip.`, 
                        timestamp: now.toISOString() 
                    }],
                };

                newClients.push(newClient);
                importCount++;
            });

            return { newClients, importCount, skippedCount };
        };

        const renderBulkAddClientForm = () => {
             const container = document.getElementById('BulkAddClient');
             if (!container) return;

             container.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
                    <form id="bulk-client-form" class="bg-gray-900 p-8 rounded-xl w-full max-w-4xl border border-purple-600 shadow-3xl max-h-screen overflow-y-auto">
                        <h2 class="text-2xl font-bold text-white mb-6">Bulk Import Clients (Paste CSV)</h2>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">1. Paste Your Data Here (Name, Phone, URL)</label>
                            <textarea id="csv-input" placeholder="Paste your spreadsheet/CSV data here. Example format:
John Smith, +15551234567, https://linkedin.com/john-smith
Jane Doe, 555-987-6543, 
OnlyName, +15551112222
" required class="${baseClasses.input} h-48"></textarea>
                            <p class="text-xs ${baseClasses.secondaryText} mt-1">Each line is one client. Phone number is required for each row.</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">2. Select Drip Campaign for Import</label>
                                <select id="bulk-dripCampaignId" required class="${baseClasses.input}">
                                    ${data.drips.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                                </select>
                            </div>
                            <div id="import-summary" class="p-2 pt-6 text-sm text-gray-300">
                                <!-- Summary injected here -->
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 mt-8">
                            <button type="button" id="cancel-bulk-add" class="py-2 px-4 rounded-lg ${baseClasses.accentOutline} hover:bg-gray-700/50">
                                Cancel
                            </button>
                            <button type="submit" class="py-2 px-4 rounded-lg font-bold ${baseClasses.accent}">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                Import and Enroll Clients
                            </button>
                        </div>
                    </form>
                </div>
             `;

             const summaryEl = document.getElementById('import-summary');
             const csvInputEl = document.getElementById('csv-input');
             
             const updateSummary = () => {
                 const rawText = csvInputEl.value;
                 const lineCount = rawText.trim().split('\n').filter(line => line.trim() !== '').length;
                 summaryEl.innerHTML = `
                    <p>Lines detected: <span class="font-bold text-white">${lineCount}</span></p>
                    <p class="text-xs ${baseClasses.secondaryText} mt-1">
                        Review your data before importing. Invalid rows (missing phone) will be skipped.
                    </p>
                 `;
             };

             csvInputEl.addEventListener('input', updateSummary);
             updateSummary(); // Initial summary render

             document.getElementById('cancel-bulk-add').onclick = () => navigateTo('Clients');
             
             document.getElementById('bulk-client-form').onsubmit = (e) => {
                e.preventDefault();
                
                const rawText = document.getElementById('csv-input').value;
                const dripCampaignId = document.getElementById('bulk-dripCampaignId').value;

                if (!rawText || !dripCampaignId) return;

                const { newClients, importCount, skippedCount } = parsePastedData(rawText, dripCampaignId);

                if (importCount === 0) {
                    alert(`No valid clients to import. Please check that every row has a phone number.`);
                    return;
                }

                // Append new clients to the global data store
                data.clients.push(...newClients);
                saveData(data.clients, data.drips);
                
                // Show final summary and navigate
                alert(`Import complete! Successfully imported ${importCount} clients. ${skippedCount} rows skipped due to missing/invalid phone number.`);
                navigateTo('Clients');
             };
        };


        // --- Client Profile Renderer ---
        
        const renderClientProfile = (client) => {
            const container = document.getElementById('Profile');
            if (!container) return;
            
            // Re-fetch client data to ensure it's up-to-date
            const currentClient = data.clients.find(c => c.id === client.id) || client;
            const drip = data.drips.find(d => d.id === currentClient.dripCampaignId);
            const progress = (currentClient.currentMessageIndex / TOTAL_MESSAGES) * 100;
            const history = (currentClient.notes || [])
                .map(note => ({ ...note, timestamp: new Date(note.timestamp) }))
                .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

            const getMessageContent = (index) => {
                const templateContent = drip?.messages[String(index)] || `[ERROR: Template Message ${index} not found]`;
                const customContent = currentClient.customMessages?.[String(index)];
                
                let content = customContent || templateContent;
                // ENHANCEMENT: Full personalization rendering for preview
                content = content.replace(/\{\{firstName\}\}/g, currentClient.firstName || 'Client');
                content = content.replace(/\{\{lastName\}\}/g, currentClient.lastName || 'Client');
                content = content.replace(/\{\{URL\}\}/g, currentClient.url || '[No URL]');
                return content;
            };

            container.innerHTML = `
                <div class="p-8 relative">
                    <header class="flex items-center justify-between mb-8">
                        <div class="flex items-center">
                            <button id="back-to-clients" class="mr-4 text-gray-400 hover:text-white transition" title="Back to Clients List">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                            </button>
                            <h1 class="text-3xl font-bold text-white">${currentClient.firstName} ${currentClient.lastName}</h1>
                        </div>
                        
                        <!-- Toggle for the History Panel -->
                        <button id="toggle-notes-panel" class="py-2 px-4 rounded-xl flex items-center gap-2 font-semibold ${baseClasses.accent}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 3h3m-3 3h3M9 16h1m-1 0h1" /></svg>
                            Notes/History
                        </button>
                    </header>
        
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pr-96">
                        <!-- COLUMN 1 & 2: Details & Progress -->
                        <div class="lg:col-span-3 space-y-8">
                            <!-- CLIENT DETAILS -->
                            <div id="details-section" class="${baseClasses.secondaryBg} p-6 rounded-xl shadow-2xl">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">Client Details</h2>
                                    <div class="flex space-x-3">
                                        <button id="delete-client-btn" class="py-1 px-3 rounded-lg text-sm font-bold bg-red-700 hover:bg-red-800 text-white transition">Delete Client</button>
                                        <button id="save-details-btn" class="py-1 px-3 rounded-lg text-sm font-bold ${baseClasses.accent}">Save Details</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="${baseClasses.secondaryText}">First Name
                                        <input type="text" id="detail-firstName" value="${currentClient.firstName}" class="${baseClasses.input}" />
                                    </label>
                                    <label class="${baseClasses.secondaryText}">Last Name
                                        <input type="text" id="detail-lastName" value="${currentClient.lastName}" class="${baseClasses.input}" />
                                    </label>
                                    <label class="${baseClasses.secondaryText}">Phone Number
                                        <input type="tel" id="detail-phone" value="${currentClient.phone}" class="${baseClasses.input}" />
                                    </label>
                                    <label class="${baseClasses.secondaryText}">URL (LinkedIn, etc.)
                                        <input type="url" id="detail-url" value="${currentClient.url}" class="${baseClasses.input}" />
                                    </label>
                                </div>
                                <label class="${baseClasses.secondaryText} mt-4 block">Drip Campaign
                                    <select id="detail-dripCampaignId" class="${baseClasses.input}">
                                        ${data.drips.map(d => `<option value="${d.id}" ${d.id === currentClient.dripCampaignId ? 'selected' : ''}>${d.name}</option>`).join('')}
                                    </select>
                                </label>
                            </div>
        
                            <!-- DRIP PROGRESS & MESSAGES -->
                            <div class="${baseClasses.secondaryBg} p-6 rounded-xl shadow-2xl">
                                <h2 class="text-xl font-bold text-white mb-4">Drip Progress & Messages</h2>
                                <p class="${baseClasses.secondaryText}">
                                    ${currentClient.firstName} is on message **${currentClient.currentMessageIndex} of ${TOTAL_MESSAGES}**.
                                </p>
                                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6 mt-2">
                                    <div class="bg-purple-600 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                                </div>
        
                                <div id="messages-accordion" class="space-y-4">
                                    <!-- Messages injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 3: Notes and History (SLIDE OUT PANEL) -->
                <div id="notes-panel" class="fixed top-0 right-0 h-full w-96 ${baseClasses.primaryBg} shadow-2xl border-l border-gray-700 slide-panel overflow-y-auto ${isNotesPanelOpen ? 'open' : ''}">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                            <h2 class="text-xl font-bold text-white">History & Notes</h2>
                            <button id="close-notes-panel" class="text-gray-400 hover:text-white transition">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        
                        <!-- ADD NOTE -->
                        <div class="${baseClasses.secondaryBg} p-4 rounded-xl shadow-inner mb-6">
                            <h3 class="text-lg font-bold text-white mb-3">Add a Note</h3>
                            <textarea id="note-content" placeholder="Add a new note..." class="${baseClasses.input} h-24"></textarea>
                            <button id="add-note-btn" class="mt-3 py-2 px-4 rounded-lg font-bold w-full ${baseClasses.accent}">Add Note</button>
                        </div>

                        <!-- HISTORY LIST -->
                        <div class="${baseClasses.secondaryBg} p-4 rounded-xl shadow-inner">
                            <h3 class="text-lg font-bold text-white mb-3">Timeline</h3>
                            <div id="history-list" class="mt-4 max-h-[70vh] overflow-y-auto space-y-4">
                                <!-- History items injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // --- Attach Listeners to New Panel ---
            document.getElementById('back-to-clients').onclick = () => navigateTo('Clients');
            document.getElementById('delete-client-btn').onclick = () => handleDeleteClient(currentClient.id); 
            
            document.getElementById('toggle-notes-panel').onclick = () => {
                isNotesPanelOpen = !isNotesPanelOpen;
                renderClientProfile(currentClient); // Re-render to update panel class
            };
            document.getElementById('close-notes-panel').onclick = () => {
                isNotesPanelOpen = false;
                renderClientProfile(currentClient); // Re-render to update panel class
            };

            // --- Message Accordion Rendering & Logic (Same as before) ---
            const messagesContainer = document.getElementById('messages-accordion');
            // ... (message rendering logic remains the same) ...
            for (let i = 1; i <= TOTAL_MESSAGES; i++) {
                const index = String(i);
                const rawContent = client.customMessages?.[index] || drip?.messages[index] || '';
                const displayContent = getMessageContent(i);

                const isCustomized = !!currentClient.customMessages?.[index];
                const isCurrent = i === currentClient.currentMessageIndex;
                const isSent = i < currentClient.currentMessageIndex;
                const messageClasses = isCurrent ? "bg-purple-900/50" : (isSent ? "bg-gray-700/50" : baseClasses.secondaryBg);
                
                const messageEl = document.createElement('div');
                messageEl.className = `${messageClasses} p-4 rounded-xl shadow-md border-l-4 ${isCurrent ? 'border-purple-500' : 'border-gray-700'}`;
                messageEl.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer message-header" data-index="${index}">
                        <h4 class="text-lg font-semibold ${isCurrent ? 'text-purple-300' : 'text-white'}">
                            Message ${index} of ${TOTAL_MESSAGES} 
                            ${isCurrent ? '<span class="ml-2 text-sm bg-purple-500 px-2 py-0.5 rounded-full">CURRENT</span>' : ''}
                            ${isCustomized ? '<span class="ml-2 text-sm bg-yellow-600 px-2 py-0.5 rounded-full text-black">CUSTOM</span>' : ''}
                            ${isSent ? '<span class="ml-2 text-sm text-green-400">SENT</span>' : ''}
                        </h4>
                        <svg class="w-5 h-5 transition-transform text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div id="msg-detail-${index}" class="mt-3 hidden">
                        <p class="${baseClasses.secondaryText} text-xs mb-1">Preview:</p>
                        <div class="mb-3 p-2 rounded-lg bg-gray-700 text-gray-200 text-sm italic">${displayContent}</div>

                        <textarea id="msg-textarea-${index}" class="${baseClasses.input} h-32 text-sm">${rawContent}</textarea>
                        <button data-index="${index}" class="save-msg-edit mt-2 py-2 px-4 rounded-lg font-bold ${baseClasses.accent} text-sm">Save Message Edit</button>
                        <p class="${baseClasses.secondaryText} text-xs mt-2">
                            Use **\`{{firstName}}\`**, **\`{{lastName}}\`**, and **\`{{URL}}\`** for personalization.
                        </p>
                    </div>
                `;
                messagesContainer.appendChild(messageEl);
            }
            
            messagesContainer.querySelectorAll('.message-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const index = header.dataset.index;
                    const detailEl = document.getElementById(`msg-detail-${index}`);
                    detailEl.classList.toggle('hidden');
                    header.querySelector('svg').classList.toggle('rotate-180');
                });
            });

            messagesContainer.querySelectorAll('.save-msg-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.index;
                    const newContent = document.getElementById(`msg-textarea-${index}`).value;
                    handleSaveCustomMessages(currentClient.id, index, newContent);
                });
            });
            
            const handleSaveCustomMessages = (clientId, messageIndex, newContent) => {
                const clientIndex = data.clients.findIndex(c => c.id === clientId);
                if (clientIndex === -1) return;

                const client = data.clients[clientIndex];
                const updatedCustomMessages = {
                    ...client.customMessages,
                    [String(messageIndex)]: newContent
                };
                
                // Log History
                const logContent = `Customized Message ${messageIndex} of ${TOTAL_MESSAGES}.`;
                const messageNote = { type: 'Message Edit', content: logContent, timestamp: new Date().toISOString() };
                const updatedNotes = [...(client.notes || []), messageNote];

                // Update data and refresh
                data.clients[clientIndex].customMessages = updatedCustomMessages;
                data.clients[clientIndex].notes = updatedNotes;
                saveData(data.clients, data.drips);
                
                // Re-render the profile to update the view
                const updatedClient = data.clients[clientIndex];
                renderClientProfile(updatedClient);
            };

            // --- Details Save Logic ---
            document.getElementById('save-details-btn').addEventListener('click', () => {
                const clientIndex = data.clients.findIndex(c => c.id === currentClient.id);
                if (clientIndex === -1) return;

                const oldClient = data.clients[clientIndex];
                const updatedFields = {};
                let logContent = 'Updated client details: ';
                let changesMade = false;
                
                const fields = ['firstName', 'lastName', 'phone', 'url', 'dripCampaignId'];
                
                fields.forEach(field => {
                    const inputEl = document.getElementById(`detail-${field}`);
                    if (inputEl && inputEl.value !== oldClient[field]) {
                        updatedFields[field] = inputEl.value;
                        logContent += `${field} changed to '${inputEl.value}'; `;
                        changesMade = true;
                    }
                });

                if (changesMade) {
                    const detailNote = { type: 'Details Update', content: logContent.trim(), timestamp: new Date().toISOString() };
                    const updatedNotes = [...(oldClient.notes || []), detailNote];
                    
                    data.clients[clientIndex] = { ...oldClient, ...updatedFields, notes: updatedNotes };
                    saveData(data.clients, data.drips);
                    console.log("Client details and history updated.");
                    
                    // Re-render with the updated data
                    renderClientProfile(data.clients[clientIndex]); 
                } else {
                    console.log("No changes detected in client details.");
                }
            });

            // --- Add Note Logic ---
            document.getElementById('add-note-btn').addEventListener('click', () => {
                const noteContent = document.getElementById('note-content').value.trim();
                if (!noteContent) return;

                const clientIndex = data.clients.findIndex(c => c.id === currentClient.id);
                if (clientIndex === -1) return;

                const note = {
                    type: 'Note',
                    content: noteContent,
                    timestamp: new Date().toISOString(),
                };

                const updatedNotes = [...(data.clients[clientIndex].notes || []), note];
                data.clients[clientIndex].notes = updatedNotes;
                saveData(data.clients, data.drips);
                
                document.getElementById('note-content').value = '';
                console.log("Note added to history.");
                
                // Re-render the profile to update the history list
                const updatedClient = data.clients[clientIndex];
                renderClientProfile(updatedClient);
            });
            
            // --- History Rendering ---
            const historyListEl = document.getElementById('history-list');
            historyListEl.innerHTML = history.map(item => `
                <div class="border-l border-purple-500 pl-4">
                    <p class="text-sm font-semibold text-purple-400">
                        ${item.type} on ${item.timestamp.toLocaleDateString()} at ${item.timestamp.toLocaleTimeString()}
                    </p>
                    <p class="text-gray-300 text-sm italic">${item.content}</p>
                </div>
            `).join('');

            if (history.length === 0) {
                 historyListEl.innerHTML = `<p class="${baseClasses.secondaryText}">No notes or messages logged yet.</p>`;
            }
        };

        // --- Dashboard Renderer ---

        const renderDashboard = () => {
            const container = document.getElementById('Dashboard');
            if (!container) return;

            // Simple template for the Dashboard UI
            container.innerHTML = `
                <div class="p-8">
                    <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                        <div class="flex space-x-2">
                            <button id="card-view-btn" data-view="card" title="Card View" class="p-2 rounded-xl transition ${dashboardViewType === 'card' ? baseClasses.accent : baseClasses.accentOutline}">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            </button>
                            <button id="table-view-btn" data-view="table" title="Table View" class="p-2 rounded-xl transition ${dashboardViewType === 'table' ? baseClasses.accent : baseClasses.accentOutline}">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                            </button>
                        </div>
                    </header>
                    
                    <div id="stats-section" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>

                    <!-- NEW: Search Input on Dashboard -->
                    <div class="${baseClasses.secondaryBg} p-4 rounded-xl mb-6 shadow-inner">
                        <input type="text" id="dashboard-search" placeholder="Search tasks by Name or Phone..." class="${baseClasses.input} w-full text-white" />
                    </div>
                    
                    <div class="mb-8">
                        <p class="${baseClasses.secondaryText} text-lg" id="task-count">Showing 0 tasks matching criteria.</p>
                        <p class="${baseClasses.secondaryText} text-sm italic">Click $\rightarrow$ to mark as sent and schedule the next message 7 days from now (Floating Schedule).</p>
                    </div>

                    <div id="task-list-container"></div>
                </div>
            `;
            
            document.getElementById('card-view-btn').onclick = () => { dashboardViewType = 'card'; renderDashboardTasks('card'); };
            document.getElementById('table-view-btn').onclick = () => { dashboardViewType = 'table'; renderDashboardTasks('table'); };
            
            // Attach search listener
            document.getElementById('dashboard-search').oninput = () => renderDashboardTasks(dashboardViewType);


            // Initial render of tasks, stats, and filters
            renderDashboardTasks(dashboardViewType);
        };

        const renderStatCard = (title, value, icon, color, filterType) => {
            const isActive = dashboardFilter === filterType;
            return `
                <div id="stat-card-${filterType}" data-filter="${filterType}" class="p-5 ${baseClasses.secondaryBg} rounded-xl shadow-lg flex items-center justify-between border-l-4 ${color} cursor-pointer transition transform ${isActive ? 'ring-2 ring-purple-500 scale-[1.03]' : ''}">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase">${title}</p>
                        <h2 class="text-3xl font-bold text-white mt-1">${value}</h2>
                    </div>
                    <div class="p-3 bg-gray-700/50 rounded-full">
                        ${icon}
                    </div>
                </div>
            `;
        };
        
        const renderDashboardTasks = (viewType) => {
            const taskContainer = document.getElementById('task-list-container');
            const statsContainer = document.getElementById('stats-section');
            const searchInput = document.getElementById('dashboard-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            if (!taskContainer || !statsContainer) return;
            
            // --- Filtering Logic ---
            
            const allClients = data.clients.map(client => ({
                ...client,
                status: getClientStatus(client),
            }));

            const now = new Date();
            const startOfWeek = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));

            // 1. Calculate Stats
            const stats = {
                actions: allClients.filter(c => c.status === 'overdue').length,
                active: allClients.filter(c => c.status === 'active' || c.status === 'overdue').length,
                sentThisWeek: allClients.filter(c => {
                    return c.lastSentDate && new Date(c.lastSentDate).getTime() >= startOfWeek.getTime();
                }).length,
            };

            // 2. Inject Stats and Attach Click Listeners (Avoid re-injecting listeners if they exist)
            if (statsContainer.innerHTML === "") { // Only inject stats once
                statsContainer.innerHTML = `
                    ${renderStatCard("ACTIONS to Take", stats.actions, '<svg class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>', "border-red-600", "overdue")}
                    ${renderStatCard("Active Clients", stats.active, '<svg class="w-6 h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h-4v-2h4v2zM7 20h4v-2H7v2zM12 14v-2m-4 2h8m-4 4h4a2 2 0 002-2v-4h-4v4zm0 0h-4a2 2 0 00-2 2v4h4v-4zM12 6v6m0 0v6m0-6h6m-6 0H6v6m6-6v-2m0 0v-2m0 2h6m-6 0H6v2m6-2V6" /></svg>', "border-purple-600", "active")}
                    ${renderStatCard("Sent This Week", stats.sentThisWeek, '<svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>', "border-green-600", "sentThisWeek")}
                `;
            }
            
            // Re-render Stat Card classes (for active state only)
            const statCards = document.getElementById('stats-section').querySelectorAll('[data-filter]');
            statCards.forEach(card => {
                const filter = card.dataset.filter;
                card.classList.remove('ring-2', 'ring-purple-500', 'scale-[1.03]');
                if (dashboardFilter === filter) {
                    card.classList.add('ring-2', 'ring-purple-500', 'scale-[1.03]');
                }
                card.onclick = (e) => {
                    const newFilter = e.currentTarget.dataset.filter;
                    dashboardFilter = (dashboardFilter === newFilter) ? 'all' : newFilter; // Toggle filter
                    renderDashboardTasks(viewType); // Re-render tasks based on new filter
                };
            });


            // 3. Apply Filter and Search to Task List
            let filteredTasks = allClients.filter(client => {
                const matchesFilter = (dashboardFilter === 'overdue' && client.status === 'overdue') ||
                                    (dashboardFilter === 'active' && (client.status === 'active' || client.status === 'overdue')) ||
                                    (dashboardFilter === 'sentThisWeek' && client.lastSentDate && new Date(client.lastSentDate).getTime() >= startOfWeek.getTime()) ||
                                    (dashboardFilter === 'all' && client.status !== 'complete');
                
                // Apply search filter (Name or Phone)
                const fullName = `${client.firstName} ${client.lastName}`.toLowerCase();
                const matchesSearch = fullName.includes(searchTerm) || client.phone.includes(searchTerm);
                
                return matchesFilter && matchesSearch;
            });
            
            document.getElementById('task-count').textContent = `Showing ${filteredTasks.length} tasks matching criteria.`;


            if (viewType === 'card') {
                taskContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="overdue-cards-container"></div>`;
                const cardsContainer = document.getElementById('overdue-cards-container');
                
                filteredTasks.forEach(client => {
                    const messageContent = getDripContent(client.dripCampaignId, client.currentMessageIndex, client);
                    const dueText = new Date(client.nextDueDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const dripName = data.drips.find(d => d.id === client.dripCampaignId)?.name || 'Unknown Drip';

                    const isOverdue = client.status === 'overdue';

                    const card = document.createElement('div');
                    card.className = `w-full ${baseClasses.cardBg} p-6 rounded-xl shadow-2xl transition duration-300 transform hover:scale-[1.01] border-t-4 ${isOverdue ? 'border-red-600' : 'border-purple-600'} cursor-pointer relative`;
                    card.onclick = () => navigateTo('Profile', client);
                    
                    // Delete Button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'absolute top-2 right-2 text-red-400 hover:text-red-600 p-1 rounded-full bg-gray-900/50 hover:bg-gray-900 transition';
                    deleteButton.title = `Delete ${client.firstName}`;
                    deleteButton.innerHTML = `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    deleteButton.onclick = (e) => {
                        e.stopPropagation(); // Prevent card navigation
                        handleDeleteClient(client.id);
                    };
                    card.appendChild(deleteButton);


                    card.innerHTML += `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">${client.firstName} ${client.lastName}</h3>
                                <!-- NEW: Client Phone Number -->
                                <p class="text-xs ${baseClasses.secondaryText} mt-0.5">${client.phone}</p>
                            </div>
                            <span class="text-sm font-semibold ${isOverdue ? 'bg-red-800 text-red-100' : 'bg-purple-800 text-purple-100'} px-3 py-1 rounded-full">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                ${isOverdue ? 'Overdue' : 'Active'}
                            </span>
                        </div>
                        <p class="${baseClasses.secondaryText} text-sm">Message ${client.currentMessageIndex} of ${TOTAL_MESSAGES} (${dripName})</p>
                        <p class="${baseClasses.secondaryText} text-sm mb-4">Due: ${dueText}</p>
                        <div class="p-3 rounded-lg ${baseClasses.secondaryBg} mb-4">
                            <p class="text-sm italic text-gray-300 max-h-24 overflow-y-auto">${messageContent}</p>
                        </div>
                        <div class="flex justify-between items-center space-x-2" onclick="event.stopPropagation();">
                            <button title="Call Client" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="window.open('tel:${client.phone.replace(/[^0-9]/g, '')}', '_blank');"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.717 21 3 14.283 3 6V5z" /></svg></button>
                            <button title="WhatsApp Client" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="window.open('https://wa.me/${client.phone.replace(/[^0-9]/g, '')}', '_blank');">WA</button>
                            <button title="Copy Message" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigator.clipboard.writeText('${messageContent.replace(/'/g, "\\'")}')"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v1m-4 0v-1m4 1h-4m-4 0h-4m-4 0h-4m4 0v-1m4 1v-1m-4 1v-1" /></svg></button>
                            <button title="Edit Message / View Profile" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigateTo('Profile', data.clients.find(c => c.id === '${client.id}'));"><svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                            <button title="Mark as Sent & Schedule Next" class="p-2 rounded-lg ${baseClasses.accent} text-sm font-bold w-1/5 send-btn" data-client-id="${client.id}">
                                <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </button>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                    cardsContainer.lastChild.prepend(deleteButton); // Re-insert delete button element
                });
            } else { // Table View (No changes needed, functionality already there)
                taskContainer.innerHTML = `
                    <div class="${baseClasses.secondaryBg} rounded-xl shadow-2xl overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/6">Client</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-24">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-32">Due Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Next Message</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider w-40">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overdue-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                `;
                const tbody = document.getElementById('overdue-table-body');
                
                filteredTasks.forEach(client => {
                    const messageContent = getDripContent(client.dripCampaignId, client.currentMessageIndex, client);
                    const dueText = new Date(client.nextDueDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const isOverdue = client.status === 'overdue';
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700/50 transition duration-150';
                    row.onclick = () => navigateTo('Profile', client);

                    row.innerHTML = `
                        <td class="p-4 font-semibold text-white flex items-center cursor-pointer">
                            <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            ${client.firstName} ${client.lastName}
                        </td>
                        <td class="p-4">
                            <span class="text-xs font-semibold ${isOverdue ? 'bg-red-800 text-red-100' : 'bg-purple-800 text-purple-100'} px-3 py-1 rounded-full inline-flex items-center">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                ${isOverdue ? 'Overdue' : 'Active'}
                            </span>
                        </td>
                        <td class="p-4 text-gray-300 font-medium">${dueText}</td>
                        <td class="p-4 text-gray-300 text-sm italic">${messageContent}</td>
                        <td class="p-4 text-right">
                            <div class="flex space-x-2" onclick="event.stopPropagation();">
                                <button title="Copy Message" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigator.clipboard.writeText('${messageContent.replace(/'/g, "\\'")}')">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v1m-4 0v-1m4 1h-4m-4 0h-4m-4 0h-4m4 0v-1m4 1v-1m-4 1v-1" /></svg>
                                </button>
                                <button title="Edit Message / View Profile" class="${baseClasses.accentOutline} p-2 rounded-lg" onclick="navigateTo('Profile', data.clients.find(c => c.id === '${client.id}'));">
                                     <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                </button>
                                <button title="Mark as Sent & Schedule Next" class="p-2 rounded-lg ${baseClasses.accent} text-sm font-bold send-btn" data-client-id="${client.id}">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Attach send action listeners
            taskContainer.querySelectorAll('.send-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleSendAction(btn.dataset.clientId);
                });
            });
        };

        // --- Initializer ---

        const initializeApp = () => {
            const appEl = document.getElementById('app');
            const health = getStorageHealth(); // Get health status once at initialization

            // 1. Sidebar Structure
            const sidebarHTML = `
                <aside class="w-64 flex flex-col ${baseClasses.secondaryBg} border-r border-gray-700 p-4">
                    <div class="flex items-center text-3xl font-extrabold text-purple-500 mb-10 mt-2">
                        <span class="text-white">The</span>DRIP
                    </div>
                    
                    <nav class="flex-grow space-y-2">
                        <button data-view="Dashboard" class="nav-item w-full flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700/70 hover:text-white">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 00-1-1h-3M10 9l-2 2m0 0l-7-7m7 7h3v-3m0 0H6v3m3 0H6v3m0 0h3v-3m-3 3h3v-3m0 3H6v-3" /></svg>
                            <span class="ml-4">Dashboard</span>
                        </button>
                        <button data-view="Clients" class="nav-item w-full flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700/70 hover:text-white">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h-4v-2h4v2zM7 20h4v-2H7v2zM12 14v-2m-4 2h8m-4 4h4a2 2 0 002-2v-4h-4v4zm0 0h-4a2 2 0 00-2 2v4h4v-4zM12 6v6m0 0v6m0-6h6m-6 0H6v6m6-6v-2m0 0v-2m0 2h6m-6 0H6v2m6-2V6" /></svg>
                            <span class="ml-4">Clients</span>
                        </button>
                        <button data-view="Drips" class="nav-item w-full flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700/70 hover:text-white">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            <span class="ml-4">Drips</span>
                        </button>
                    </nav>

                    <!-- System Health Moved Here -->
                    <div class="mt-auto pt-4 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-gray-400 mb-1">System Health</h3>
                        <p class="text-xs ${baseClasses.secondaryText}">
                            Clients: <span class="font-bold text-white">${health.totalClients}</span> | 
                            Size: <span class="font-bold text-white">${health.totalKB} KB</span>
                        </p>
                        <p class="text-xs font-semibold ${health.healthColor}">
                             Status: ${health.healthStatus}
                        </p>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <p class="${baseClasses.secondaryText} text-xs truncate">
                            Status: <span class="text-green-400">Local (No DB)</span>
                        </p>
                        <button onclick="localStorage.clear(); window.location.reload();" class="mt-2 text-xs py-1 px-2 rounded-lg text-red-400 border border-red-400 hover:bg-red-900/50 w-full">
                            Clear Local Data
                        </button>
                    </div>
                </aside>
            `;

            // 2. Main Content Area Structure (All views are hidden divs)
            const mainContentHTML = `
                <main class="flex-1 overflow-y-auto">
                    <div id="Dashboard" data-view="Dashboard" class="router-view p-8 hidden"></div>
                    <div id="Clients" data-view="Clients" class="router-view p-8 hidden"></div>
                    <div id="Drips" data-view="Drips" class="router-view p-8 hidden"></div>
                    <div id="Profile" data-view="Profile" class="router-view p-8 hidden"></div>
                    <div id="AddClient" data-view="AddClient" class="router-view p-8 hidden"></div>
                    <div id="AddDrip" data-view="AddDrip" class="router-view p-8 hidden"></div> <!-- New Drip View -->
                    <div id="BulkAddClient" data-view="BulkAddClient" class="router-view p-8 hidden"></div> <!-- Bulk Add View -->
                </main>
            `;

            appEl.innerHTML = sidebarHTML + mainContentHTML;
            
            // 3. Attach Sidebar Nav Listeners
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    navigateTo(e.currentTarget.dataset.view);
                });
            });

            // 4. Initial Navigation
            navigateTo(currentView);
        };

        window.onload = initializeApp;

    </script>
</body>
</html>
